esphome:
  name: esphome-web-5a16c4
  friendly_name: UltimateReader
  min_version: 2026.1.3
  name_add_mac_suffix: false

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

external_components:
  - source: github://Kustonium/esphome-wmbus-bridge@main
    components: [wmbus_common, wmbus_radio]
    refresh: 0s

logger:
  level: info                  # Zmień na 'warn' jeśli chcesz ciszej w logach
  logs:
    mqtt: warn                 # Ucisza MQTT (zostawia warningi)
    component: warn           # Ucisza ogólne gadanie ESPHome
    #wmbus: info              # (opcjonalnie) wymuś logi wmbus, jeśli kiedyś znikną

mdns:
  disabled: false               # Wyłączone mDNS = mniej usług/gniazd/szumu => daj true jak się nie kompiluje 

ota:
  - platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none        # Stabilniej pod RF/MQTT (kosztem prądu)

mqtt:
  broker: !secret mqtt_broker
  username: !secret mqtt_user
  password: !secret mqtt_password
  # Uwaga: jeśli chcesz TYLKO MQTT, nie dodawaj 'api:' ani web_server.

spi:
  id: spi_lora
  clk_pin: GPIO05
  mosi_pin: GPIO06
  miso_pin: GPIO03             # Ostrzeżenie: strapping pin – u Ciebie działa, ale miej to z tyłu głowy

# === LED (LilyGO T3-S3 v1.2) ===
# Jeśli chcesz BEZ MIGANIA:
# - usuń cały blok 'output:' poniżej
# - oraz usuń/zakomentuj 3 linie output.turn_on/delay/output.turn_off w on_frame
output:
  - platform: gpio
    id: status_led
    pin:
      number: GPIO37           # On-board LED na T3-S3 v1.2
      # inverted: true         # Odkomentuj, jeśli LED świeci "odwrotnie" (np. ciągle lub nie gaśnie)

# === wM-Bus Radio ===
wmbus_radio:
  radio_type: SX1276
  spi_id: spi_lora
  cs_pin: GPIO07
  reset_pin: GPIO08
  irq_pin:
    number: GPIO33
    mode:
      input: true
      pullup: true

  on_frame:
    then:
      - if:
          condition:
            lambda: |-
              return frame->as_hex().size() >= 30;
          then:
            - mqtt.publish:
                topic: "wmbus_bridge/telegram"
                payload: !lambda |-
                  return frame->as_hex();
            # === MIGANIE LED (usuń te 3 linie jeśli nie chcesz migania) ===
            - output.turn_on: status_led
            - delay: 50ms
            - output.turn_off: status_led